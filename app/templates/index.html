<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Insurance Tracker (MongoDB)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">Insurance Tracker</h1>

  <form class="bg-white p-4 rounded shadow mb-6" action="/add" method="post" enctype="multipart/form-data">
    <div class="grid grid-cols-2 gap-4">
      <input type="text" name="name" placeholder="Name" required class="border p-2 rounded">
      <input type="text" name="phone" placeholder="Phone (+407...)" required class="border p-2 rounded">
      <input type="text" name="car_name" placeholder="Car Name" required class="border p-2 rounded">
      <input type="text" name="plate_number" placeholder="Plate (e.g. IS 12 ABC)" required class="border p-2 rounded">
      <input type="text" name="vin_number" placeholder="VIN Number" required class="border p-2 rounded">
      <input type="date" name="insurance_start" required class="border p-2 rounded">
      <input type="date" name="insurance_end" required class="border p-2 rounded">
      <input type="file" name="pdf" accept="application/pdf" class="border p-2 rounded">
    </div>
    <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Add Insurance</button>
  </form>

  <div class="mb-4 flex gap-2">
    <a href="/export_csv" class="bg-green-600 text-white px-4 py-2 rounded">Download All CSV</a>
    <button id="exportSelected" class="bg-yellow-600 text-white px-4 py-2 rounded">Export Selected</button>
  </div>
  
  <div class="flex justify-end mb-4">
    <a href="/audit" class="bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded">
        View Audit Log
    </a>
  </div>

  <form id="selectedForm" method="post" action="/export_selected_csv">
    <input type="hidden" id="selected_ids" name="selected_ids">
    <table class="w-full bg-white rounded shadow text-center">
      <thead class="bg-blue-100">
        <tr>
          <th class="p-2"><input type="checkbox" id="selectAll"></th>
          <th class="p-2">Name</th>
          <th class="p-2">Car</th>
          <th class="p-2">Phone</th>
          <th class="p-2">Plate</th>
          <th class="p-2">VIN</th>
          <th class="p-2">Start</th>
          <th class="p-2">End</th>
          <th class="p-2">Days Left</th>
          <th class="p-2">Actions</th>

        </tr>
      </thead>
      <tbody>
        {% for r in items %}
        <tr class="text-center {% if r.days_left is not none and r.days_left < 7 %}bg-red-100{% endif %}">
          <td class="p-2"><input type="checkbox" class="selectRow" value="{{ r.id }}"></td>
          <td class="p-2">{{ r.name }}</td>
          <td class="p-2">{{ r.car_name }}</td>
          <td class="p-2 text-center">
            {% if r.phone %}
                <a href="https://wa.me/{{ r.phone | replace('+', '') }}"
                target="_blank"
                class="inline-flex items-center justify-center text-green-600 hover:text-green-700 space-x-1">
                <span>{{ r.phone }}</span>
                </a>
            {% else %}
                —
            {% endif %}
          </td>
          <td class="p-2">{{ r.plate_number }}</td>
          <td class="p-2">{{ r.vin_number }}</td>
          <td class="p-2">{{ r.insurance_start }}</td>
          <td class="p-2">{{ r.insurance_end }}</td>
          <td class="p-2">{{ r.days_left if r.days_left is not none else '—' }}</td>
          <td class="p-2">
            <div class="flex justify-center space-x-3">
                
                {% if r.pdf_id %}
                <a href="/download/{{ r.id }}" 
                    class="text-blue-600 hover:underline">
                    Download
                </a>
                {% else %}
                <span class="text-gray-400">—</span>
                {% endif %}

                <a href="/edit/{{ r.id }}" 
                class="text-indigo-600 hover:text-indigo-800 font-semibold">
                Edit
                </a>

                <form action="/delete/{{ r.id }}" method="post"
                    onsubmit="return confirm('Are you sure you want to delete this record?');"
                    class="inline">
                <button type="submit"
                        class="text-red-600 hover:text-red-800 font-semibold">
                    Delete
                </button>
                </form>

            </div>


          </td>

        </tr>

          <div class="p-4 bg-blue-50 rounded mb-4">
            <label class="block font-semibold mb-2">Import from PDF (Policy or Offer)</label>
            <input type="file" id="pdfImport" accept="application/pdf" class="border rounded p-2 w-full">
            <p id="importStatus" class="text-sm text-gray-600 mt-2"></p>
          </div>
        {% endfor %}
      </tbody>
    </table>
  </form>

  <script>
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.selectRow');
    selectAll.addEventListener('click', () => {
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
    });

    document.getElementById('exportSelected').addEventListener('click', () => {
      const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      if (selected.length === 0) {
        alert("Select at least one entry to export!");
        return;
      }
      document.getElementById('selected_ids').value = selected.join(",");
      document.getElementById('selectedForm').submit();
    });
    document.getElementById('pdfImport').addEventListener('change', async function (event) {
    const file = event.target.files[0];
    if (!file) return;
    const status = document.getElementById('importStatus');
    status.textContent = "Uploading and parsing PDF...";

    const formData = new FormData();
    formData.append("file", file);

      try {
          const res = await fetch("/import_pdf", { method: "POST", body: formData });
          const data = await res.json();

          if (data.success) {
              const f = data.parsed_data;
              document.querySelector('[name="name"]').value = f.name || "";
              document.querySelector('[name="phone"]').value = f.phone || "";
              document.querySelector('[name="car_name"]').value = `${f.car_make || ""} ${f.car_model || ""}`.trim();
              document.querySelector('[name="plate_number"]').value = f.plate_number || "";
              document.querySelector('[name="vin_number"]').value = f.vin_number || "";
              document.querySelector('[name="insurance_start"]').value = f.insurance_start || "";
              document.querySelector('[name="insurance_end"]').value = f.insurance_end || "";

              status.textContent = `✅ Imported successfully from ${data.filename}`;
              status.classList.remove("text-red-600");
              status.classList.add("text-green-600");
          } else {
              throw new Error(data.detail || "Could not extract data");
          }
      } catch (e) {
          status.textContent = "❌ Failed to import: " + e.message;
          status.classList.remove("text-green-600");
          status.classList.add("text-red-600");
      }
  });
  </script>
</body>
</html>
